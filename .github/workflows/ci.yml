name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout thinkt-web
        uses: actions/checkout@v4
        with:
          path: thinkt-web

      - name: Checkout ts-thinkt
        uses: actions/checkout@v4
        with:
          repository: wethinkt/ts-thinkt
          path: ts-thinkt

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm
          cache-dependency-path: |
            ts-thinkt/package-lock.json
            thinkt-web/package-lock.json

      - name: Build ts-thinkt
        working-directory: ts-thinkt
        run: npm ci && npm run build:fast

      - name: Install thinkt-web dependencies
        working-directory: thinkt-web
        run: npm ci

      - name: Lint
        working-directory: thinkt-web
        run: npm run lint

      - name: Typecheck
        working-directory: thinkt-web
        run: npm run typecheck

      - name: Test
        working-directory: thinkt-web
        run: npx vitest run --passWithNoTests

      - name: Build
        working-directory: thinkt-web
        run: npx vite build

      - name: Validate build
        working-directory: thinkt-web
        run: |
          test -f dist/index.html
          test -d dist/assets

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: thinkt-web/dist/
          retention-days: 7

  deploy-dist:
    name: Deploy to dist branch
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout thinkt-web
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: _dist

      - name: Deploy to dist branch
        run: |
          SOURCE_SHA=$(git rev-parse --short HEAD)
          SOURCE_MSG=$(git log -1 --pretty=%s)

          # Save build output outside the working tree
          cp -r _dist /tmp/_dist_output

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch dist branch if it exists
          git fetch origin dist:dist 2>/dev/null || true

          # Switch to dist branch (create orphan if new)
          if git show-ref --verify --quiet refs/heads/dist; then
            git checkout dist
          else
            git checkout --orphan dist
            git rm -rf .
          fi

          # Clean working tree and copy build output
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          cp -r /tmp/_dist_output/* .

          # Commit and push (skip if no changes)
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to dist â€” skipping commit"
          else
            git commit -m "dist: ${SOURCE_MSG} (${SOURCE_SHA})"
            git push origin dist
          fi
